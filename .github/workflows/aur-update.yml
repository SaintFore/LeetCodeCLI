name: Update AUR Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  update-aur-bin:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR binary repository
      run: |
        echo "Cloning AUR binary repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli-bin.git aur-repo-bin || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Update binary package files
      run: |
        # Update version in AUR binary repository
        cd aur-repo-bin
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        # Update PKGBUILD version
        sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|^source=.*|source=(\"https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\")|" PKGBUILD

        # Generate .SRCINFO using Docker and makepkg with updpkgsums
        docker run --rm -v $(pwd):/build archlinux:latest bash -c "
          set -e
          cd /build

          # Install dependencies including pacman-contrib for updpkgsums
          pacman -Sy --noconfirm base-devel pacman-contrib

          # ğŸ”¥ å…³é”®: ä½¿ç”¨ updpkgsums è‡ªåŠ¨æ›´æ–°æ ¡éªŒå’Œ
          echo 'Running updpkgsums to update SHA256 checksums...'
          updpkgsums

          # Generate .SRCINFO
          useradd -m builder
          chown -R builder:builder /build
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
        "

        # ğŸ”¥ å…³é”®:ä¿®å¤Dockeråˆ›å»ºçš„æ–‡ä»¶çš„æƒé™
        sudo chown -R $(id -u):$(id -g) .

        # Verify generated .SRCINFO and updated checksums
        echo "Updated PKGBUILD checksums:"
        grep "sha256sums=" PKGBUILD
        echo "Generated .SRCINFO:"
        cat .SRCINFO | head -20

    - name: Commit and push binary package
      run: |
        cd aur-repo-bin
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # Check if there are changes
        if git diff --quiet PKGBUILD .SRCINFO; then
          echo "No changes detected"
          exit 0
        fi

        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master

  update-aur-main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR main repository
      run: |
        echo "Cloning AUR main repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli.git aur-repo-main || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Update main package files
      run: |
        # Copy updated files
        echo "Copying PKGBUILD file..."
        cp PKGBUILD aur-repo-main/

        # Update version
        cd aur-repo-main
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        # Update PKGBUILD version
        sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|^source=.*|source=(\"https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\")|" PKGBUILD

        # Generate .SRCINFO using Docker and makepkg with updpkgsums
        docker run --rm -v $(pwd):/build archlinux:latest bash -c "
          set -e
          cd /build

          # Install dependencies including pacman-contrib for updpkgsums
          pacman -Sy --noconfirm base-devel pacman-contrib

          # ğŸ”¥ å…³é”®: ä½¿ç”¨ updpkgsums è‡ªåŠ¨æ›´æ–°æ ¡éªŒå’Œ
          echo 'Running updpkgsums to update SHA256 checksums...'
          updpkgsums

          # Generate .SRCINFO
          useradd -m builder
          chown -R builder:builder /build
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
        "

        # ğŸ”¥ å…³é”®:ä¿®å¤Dockeråˆ›å»ºçš„æ–‡ä»¶çš„æƒé™
        sudo chown -R $(id -u):$(id -g) .

        # Verify generated .SRCINFO and updated checksums
        echo "Updated PKGBUILD checksums:"
        grep "sha256sums=" PKGBUILD
        echo "Generated .SRCINFO:"
        cat .SRCINFO | head -20

    - name: Commit and push main package
      run: |
        cd aur-repo-main
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # Check if there are changes
        if git diff --quiet PKGBUILD .SRCINFO; then
          echo "No changes detected"
          exit 0
        fi

        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master