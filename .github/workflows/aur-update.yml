name: Update AUR Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  update-aur-bin:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org

    - name: Clone AUR binary repository
      run: |
        echo "Cloning AUR binary repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli-bin.git aur-repo-bin || echo "Git clone failed, continuing..."

    - name: Update binary package files
      run: |
        # Copy updated files
        echo "Copying PKGBUILD and .SRCINFO files..."
        cp leetcode-fsrs-cli-bin/PKGBUILD aur-repo-bin/
        cp leetcode-fsrs-cli-bin/.SRCINFO aur-repo-bin/

        # Update version
        cd aur-repo-bin
        LATEST_TAG=${{ github.ref_name }}
        VERSION=${LATEST_TAG#refs/tags/v}

        # Update PKGBUILD version
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|source=.*|source=\"v$VERSION.tar.gz::https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\"|" PKGBUILD

        # Update .SRCINFO
        makepkg --printsrcinfo > .SRCINFO

    - name: Commit and push binary package
      run: |
        cd aur-repo-bin
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master

  update-aur-main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org

    - name: Clone AUR main repository
      run: |
        echo "Cloning AUR main repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli.git aur-repo-main || echo "Git clone failed, continuing..."

    - name: Update main package files
      run: |
        # Copy updated files
        echo "Copying PKGBUILD file..."
        cp PKGBUILD aur-repo-main/

        # Update version
        cd aur-repo-main
        LATEST_TAG=${{ github.ref_name }}
        VERSION=${LATEST_TAG#refs/tags/v}

        # Update PKGBUILD version
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|source=.*|source=\"https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\"|" PKGBUILD

        # Update .SRCINFO
        makepkg --printsrcinfo > .SRCINFO

    - name: Commit and push main package
      run: |
        cd aur-repo-main
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master