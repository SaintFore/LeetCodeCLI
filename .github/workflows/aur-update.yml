name: Update AUR Packages

on:
  workflow_run:
    workflows: ["Build and Release Binary"]
    types:
      - completed
  workflow_dispatch:

jobs:
  update-aur-bin:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR binary repository
      run: |
        echo "Cloning AUR binary repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli-bin.git aur-repo-bin || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Download version artifact
      uses: actions/download-artifact@v4
      with:
        name: version
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update binary package files
      run: |
        # Read version from artifact
        VERSION=$(cat version.txt)
        echo "Updating to version $VERSION"
        
        # Copy PKGBUILD template
        cp aur-assets/PKGBUILD.bin aur-repo-bin/PKGBUILD
        
        # Update version in AUR binary repository
        cd aur-repo-bin

        # Update PKGBUILD version
        sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Generate .SRCINFO using Docker and makepkg with updpkgsums
        docker run --rm -v $(pwd):/build archlinux:latest bash -c "
          set -e
          cd /build

          # Install dependencies including pacman-contrib for updpkgsums
          pacman -Sy --noconfirm base-devel pacman-contrib

          # Create non-root user for makepkg operations
          useradd -m builder
          chown -R builder:builder /build

          # ğŸ”¥ å…³é”®: ä½¿ç”¨ updpkgsums è‡ªåŠ¨æ›´æ–°æ ¡éªŒå’Œ (ä»¥builderç”¨æˆ·è¿è¡Œ)
          echo 'Running updpkgsums to update SHA256 checksums...'
          # Retry loop for updpkgsums in case the release asset is not yet fully available
          for i in {1..5}; do
            if su builder -c 'updpkgsums'; then
              break
            fi
            echo 'updpkgsums failed, retrying in 10s...'
            sleep 10
          done

          # Generate .SRCINFO
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
        "

        # ğŸ”¥ å…³é”®:ä¿®å¤Dockeråˆ›å»ºçš„æ–‡ä»¶çš„æƒé™
        sudo chown -R $(id -u):$(id -g) .

        # Verify generated .SRCINFO and updated checksums
        echo "Updated PKGBUILD checksums:"
        grep "sha256sums=" PKGBUILD
        echo "Generated .SRCINFO:"
        cat .SRCINFO | head -20

    - name: Commit and push binary package
      run: |
        cd aur-repo-bin
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # Check if there are changes
        if git diff --quiet PKGBUILD .SRCINFO; then
          echo "No changes detected"
          exit 0
        fi

        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master

  update-aur-main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR main repository
      run: |
        echo "Cloning AUR main repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli.git aur-repo-main || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Download version artifact
      uses: actions/download-artifact@v4
      with:
        name: version
        run-id: ${{ github.event.workflow_run.id }}
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Update main package files
      run: |
        # Read version from artifact
        VERSION=$(cat version.txt)
        echo "Updating to version $VERSION"
        
        # Copy updated files
        echo "Copying PKGBUILD file..."
        cp aur-assets/PKGBUILD aur-repo-main/

        # Update version
        cd aur-repo-main

        # Update PKGBUILD version
        sed -i "s/^pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version (preserving filename:: prefix if present, or adding it)
        # Actually, since we copy the template which HAS the prefix, we just need to ensure we replace the URL part correctly
        # The template has: source=("${pkgname}-${pkgver}::https://...")
        # We don't need to sed the source line anymore because it uses $pkgver variable!
        # Wait, the template uses $pkgver variable, so we DON'T need to sed the URL if it's dynamic.
        # Let's check the template again.
        # Template: source=("${pkgname}-${pkgver}::https://.../v$pkgver/...")
        # So when we update pkgver, the source URL automatically updates!
        # WE CAN REMOVE THE SED COMMAND FOR SOURCE URL in update-aur-bin!
        
        # But wait, update-aur-main uses a tarball source which might be different.
        # Let's look at update-aur-bin job.
        
        # In update-aur-bin, we copy PKGBUILD.bin.
        # PKGBUILD.bin has: source=("${pkgname}-${pkgver}::.../v$pkgver/...")
        # We update pkgver=...
        # So we DO NOT need to sed the source URL in update-aur-bin anymore!
        # Removing the sed command.

        # Generate .SRCINFO using Docker and makepkg with updpkgsums
        docker run --rm -v $(pwd):/build archlinux:latest bash -c "
          set -e
          cd /build

          # Install dependencies including pacman-contrib for updpkgsums
          pacman -Sy --noconfirm base-devel pacman-contrib

          # Create non-root user for makepkg operations
          useradd -m builder
          chown -R builder:builder /build

          # ğŸ”¥ å…³é”®: ä½¿ç”¨ updpkgsums è‡ªåŠ¨æ›´æ–°æ ¡éªŒå’Œ (ä»¥builderç”¨æˆ·è¿è¡Œ)
          echo 'Running updpkgsums to update SHA256 checksums...'
          su builder -c 'updpkgsums'

          # Generate .SRCINFO
          su builder -c 'makepkg --printsrcinfo > .SRCINFO'
        "

        # ğŸ”¥ å…³é”®:ä¿®å¤Dockeråˆ›å»ºçš„æ–‡ä»¶çš„æƒé™
        sudo chown -R $(id -u):$(id -g) .

        # Verify generated .SRCINFO and updated checksums
        echo "Updated PKGBUILD checksums:"
        grep "sha256sums=" PKGBUILD
        echo "Generated .SRCINFO:"
        cat .SRCINFO | head -20

    - name: Commit and push main package
      run: |
        cd aur-repo-main
        VERSION=${{ github.ref_name }}
        VERSION=${VERSION#v}

        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # Check if there are changes
        if git diff --quiet PKGBUILD .SRCINFO; then
          echo "No changes detected"
          exit 0
        fi

        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master