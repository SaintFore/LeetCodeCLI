name: Update AUR Packages

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  update-aur-bin:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR binary repository
      run: |
        echo "Cloning AUR binary repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli-bin.git aur-repo-bin || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Update binary package files
      run: |
        # Update version in AUR binary repository
        cd aur-repo-bin
        LATEST_TAG=${{ github.ref_name }}
        VERSION=${LATEST_TAG#refs/tags/v}

        # Update PKGBUILD version
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|source=.*|source=\"v$VERSION.tar.gz::https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\"|" PKGBUILD

        # Generate .SRCINFO using a simpler approach
        # Create a complete .SRCINFO file manually since we can't use makepkg in Docker
        echo "pkgbase = leetcode-fsrs-cli-bin" > .SRCINFO
        echo "\tpkgdesc = A CLI tool for LeetCode practice using FSRS spaced repetition algorithm (binary version with minimal dependencies)" >> .SRCINFO
        echo "\tpkgver = $VERSION" >> .SRCINFO
        echo "\tpkgrel = 1" >> .SRCINFO
        echo "\turl = https://github.com/SaintFore/LeetCodeCLI" >> .SRCINFO
        echo "\tarch = any" >> .SRCINFO
        echo "\tlicense = MIT" >> .SRCINFO
        echo "\tmakedepends = python-setuptools" >> .SRCINFO
        echo "\toptdepends = git: for version control integration" >> .SRCINFO
        echo "\tprovides = leetcode-fsrs-cli" >> .SRCINFO
        echo "\tconflicts = leetcode-fsrs-cli" >> .SRCINFO
        echo "\treplaces = leetcode-fsrs-cli" >> .SRCINFO
        echo "\tbackup = etc/leetcode-fsrs-cli/config.json" >> .SRCINFO
        echo "\tsource = v$VERSION.tar.gz::https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz" >> .SRCINFO
        echo "\tsha256sums = 8d75c0c035dca6981ad4b4ef99fccfa6515c112ea514bedd7c29c0387e5101dd" >> .SRCINFO
        echo "" >> .SRCINFO
        echo "pkgname = leetcode-fsrs-cli-bin" >> .SRCINFO
        echo "\tdepends = python" >> .SRCINFO
        echo "\tdepends = python-click" >> .SRCINFO
        echo "\tdepends = python-requests" >> .SRCINFO

    - name: Commit and push binary package
      run: |
        cd aur-repo-bin
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master

  update-aur-main:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}

    - name: Test SSH connection
      run: |
        ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
        echo "Testing SSH connection to AUR..."
        ssh -o StrictHostKeyChecking=no -T aur@aur.archlinux.org || true

    - name: Clone AUR main repository
      run: |
        echo "Cloning AUR main repository..."
        git clone ssh://aur@aur.archlinux.org/leetcode-fsrs-cli.git aur-repo-main || echo "Git clone failed, continuing..."

    - name: Install Arch tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget libarchive-tools

    - name: Update main package files
      run: |
        # Copy updated files
        echo "Copying PKGBUILD file..."
        cp PKGBUILD aur-repo-main/

        # Update version
        cd aur-repo-main
        LATEST_TAG=${{ github.ref_name }}
        VERSION=${LATEST_TAG#refs/tags/v}

        # Update PKGBUILD version
        sed -i "s/pkgver=.*/pkgver=$VERSION/" PKGBUILD

        # Update source URL with new version
        sed -i "s|source=.*|source=\"https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz\"|" PKGBUILD

        # Generate .SRCINFO using a simpler approach
        # Create a complete .SRCINFO file manually since we can't use makepkg in Docker
        echo "pkgbase = leetcode-fsrs-cli" > .SRCINFO
        echo "\tpkgdesc = A CLI tool for LeetCode practice using FSRS spaced repetition algorithm" >> .SRCINFO
        echo "\tpkgver = $VERSION" >> .SRCINFO
        echo "\tpkgrel = 1" >> .SRCINFO
        echo "\turl = https://github.com/SaintFore/LeetCodeCLI" >> .SRCINFO
        echo "\tarch = any" >> .SRCINFO
        echo "\tlicense = MIT" >> .SRCINFO
        echo "\tmakedepends = python-setuptools" >> .SRCINFO
        echo "\toptdepends = git: for version control integration" >> .SRCINFO
        echo "\tprovides = leetcode-fsrs-cli" >> .SRCINFO
        echo "\tconflicts = leetcode-fsrs-cli" >> .SRCINFO
        echo "\treplaces = leetcode-fsrs-cli" >> .SRCINFO
        echo "\tbackup = etc/leetcode-fsrs-cli/config.json" >> .SRCINFO
        echo "\tsource = https://github.com/SaintFore/LeetCodeCLI/archive/refs/tags/v$VERSION.tar.gz" >> .SRCINFO
        echo "\tsha256sums = 8d75c0c035dca6981ad4b4ef99fccfa6515c112ea514bedd7c29c0387e5101dd" >> .SRCINFO
        echo "" >> .SRCINFO
        echo "pkgname = leetcode-fsrs-cli" >> .SRCINFO
        echo "\tdepends = python" >> .SRCINFO
        echo "\tdepends = python-click" >> .SRCINFO
        echo "\tdepends = python-requests" >> .SRCINFO

    - name: Commit and push main package
      run: |
        cd aur-repo-main
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add PKGBUILD .SRCINFO
        git commit -m "Update to version $VERSION"
        git push origin master